<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nota de Venta - Momomy Bakery</title>
    <style>
        @page { margin: 1cm; }
        body { font-family: 'Helvetica', sans-serif; font-size: 10px; color: #333; margin: 0; padding: 0; }
        
        /* Watermark */
        #watermark {
            position: fixed;
            top: 25%;
            left: 10%;
            width: 80%;
            height: 50%;
            z-index: -1000;
            opacity: 0.08;
            text-align: center;
        }
        #watermark img { width: 400px; height: auto; transform: rotate(-30deg); }

        .cfdi-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .cfdi-box { border: 1px solid #ddd; padding: 8px; border-radius: 5px; }
        .cfdi-header { background: #f8f8f8; font-weight: bold; border-bottom: 1px solid #ddd; padding: 4px 8px; font-size: 9px; text-transform: uppercase; color: #f0427c; }
        
        .logo-area { text-align: left; vertical-align: top; }
        .logo-text { color: #f0427c; font-size: 20px; font-weight: 900; }
        
        .folio-box { text-align: center; border: 2px solid #f0427c; color: #f0427c; border-radius: 8px; padding: 10px; }
        .folio-title { font-size: 14px; font-weight: bold; }
        .folio-number { font-size: 18px; font-weight: 900; }
        
        .section-title { background: #f0427c; color: white; padding: 5px 10px; font-weight: bold; border-radius: 4px; margin: 15px 0 5px 0; }
        .label { font-weight: bold; color: #666; width: 100px; }
        
        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .items-table th { background: #eee; color: #333; padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 9px; }
        .items-table td { padding: 8px; border: 1px solid #ddd; }
        
        .totals-table { float: right; width: 250px; margin-top: 10px; }
        .totals-table td { padding: 4px; text-align: right; border-bottom: 1px solid #eee; }
        .total-row { font-weight: bold; font-size: 14px; color: #f0427c; border-bottom: 2px solid #f0427c !important; }
    </style>
</head>
<body>
    <!-- Watermark Background -->
    <div id="watermark">
        {% if business.logo_url %}
            <img src="{{ business.logo_url }}">
        {% else %}
            <div style="font-size: 150px; font-weight: 900; color: #f0427c;">MOMOMY</div>
        {% endif %}
    </div>

    <!-- Header / Emisor -->
    <table class="cfdi-table">
        <tr>
            <td width="60%" class="logo-area">
                {% if business.logo_url %}
                    <img src="{{ business.logo_url }}" style="max-height: 60px; margin-bottom: 10px;">
                {% else %}
                    <div style="display: inline-block; width: 40px; height: 40px; background: #f0427c; border-radius: 8px; color: white; text-align: center; line-height: 40px; font-size: 20px; font-weight: 900; margin-right: 10px;">M</div>
                    <span class="logo-text">{{ business.business_name }}</span>
                {% endif %}
                <div style="margin-top: 5px; color: #555; line-height: 1.4;">
                    <strong>{{ business.business_name }}</strong><br>
                    RFC: {{ business.tax_id|default('NOT-SET') }}<br>
                    Ubicación: {{ business.address }}<br>
                    Contacto: {{ business.phone }} | {{ business.email }}
                </div>
            </td>
            <td width="40%" style="vertical-align: top; padding-left: 20px;">
                <div class="folio-box">
                    <div class="folio-title">NOTA DE VENTA</div>
                    <div class="folio-number">FOLIO: {{ "%06d"|format(order.id) }}</div>
                    <div style="font-size: 8px; margin-top: 5px; color: #333;">
                        FECHA Y HORA DE EMISIÓN:<br>
                        {{ order.created_at|date("Y-m-d H:i:s") }}
                    </div>
                </div>
            </td>
        </tr>
    </table>

    <!-- Receptor -->
    <div class="cfdi-box" style="margin-top: 10px;">
        <div class="cfdi-header">DATOS DEL RECEPTOR</div>
        <table width="100%" style="margin: 5px 0;">
            <tr>
                <td width="50%">
                    <span class="label">CLIENTE:</span> {{ order.customer_first_name }} {{ order.customer_last_name }}<br>
                    <span class="label">RFC/ID:</span> Público General<br>
                    <span class="label">EMAIL:</span> {{ order.customer_email }}
                </td>
                <td width="50%">
                    <span class="label">TELÉFONO:</span> {{ order.customer_phone }}<br>
                    <span class="label">ESTADO:</span> <strong style="color: {{ order.status == 'completed' ? '#22c55e' : '#f59e0b' }}; text-transform: uppercase;">{{ order.status|default('PENDIENTE') }}</strong><br>
                    <span class="label">PAGO:</span> Efectivo / Transferencia<br>
                    <span class="label">ENTREGA:</span> Sucursal / A domicilio
                </td>
            </tr>
        </table>
    </div>

    <table class="items-table">
        <thead>
            <tr>
                <th>Producto</th>
                <th width="80" align="center">Cantidad</th>
                <th width="100" align="right">Precio Unit.</th>
                <th width="100" align="right">Subtotal</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td align="center">{{ item.quantity }}</td>
                <td align="right">${{ item.price_at_time|number_format(2) }}</td>
                <td align="right">${{ (item.quantity * item.price_at_time)|number_format(2) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals-table">
        <table>
            <tr>
                <td>SUBTOTAL:</td>
                <td>${{ (order.total_amount / 1.16)|number_format(2) }}</td>
            </tr>
            <tr>
                <td>IVA (16%):</td>
                <td>${{ (order.total_amount - (order.total_amount / 1.16))|number_format(2) }}</td>
            </tr>
            <tr class="total-row">
                <td>TOTAL:</td>
                <td>${{ order.total_amount|number_format(2) }}</td>
            </tr>
        </table>
    </div>

    <div style="clear: both; margin-top: 25px; border-top: 2px solid #000; padding-top: 15px;">
        <table width="100%">
            <tr>
                <td width="100%" style="font-size: 8px; color: #111; text-align: justify; line-height: 1.2; font-family: 'Times New Roman', Times, serif;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 9.5px; text-decoration: underline; text-transform: uppercase;">
                        CONTRATO DE ADHESIÓN DE PRESTACIÓN DE SERVICIOS DE REPOSTERÍA ARTESANAL - MOMOMY BAKERY
                    </div>

                    <strong>NOTA LEGAL IMPORTANTE:</strong>
                    El presente instrumento constituye un contrato de adhesión en términos del artículo 85 de la LFPC. Al realizar el pago del anticipo o de la totalidad del pedido, o al hacer uso de los servicios del Prestador, <strong>EL CLIENTE</strong> declara haber leído, comprendido y aceptado en forma íntegra e irrevocable todas y cada una de las cláusulas. La aceptación es tácita y equivale a la firma del presente instrumento conforme a los artículos 1794, 1796 y 1803 del Código Civil Federal.

                    <br><br><strong>DECLARACIONES PRELIMINARES:</strong>
                    <br><strong>I. EL PRESTADOR:</strong> "Momomy Bakery" es una entidad comercial dedicada a la producción y comercialización de bienes perecederos de repostería y panadería de diseño personalizado, operando bajo estándares de higiene, inocuidad alimentaria y normatividad sanitaria vigente.
                    <br><strong>II. EL CLIENTE:</strong> Persona que adquiere los servicios, declarando tener plena capacidad jurídica.
                    <br><strong>III. Marco Normativo:</strong> Este contrato se rige por el Código Civil Federal, LFPC, LFPDPPP y Ley General de Salud.

                    <br><br><strong>CLÁUSULA 1. OBJETO Y PERFECCIONAMIENTO:</strong>
                    <br>1.1. <strong>Objeto:</strong> Elaboración, personalización y entrega de productos de repostería conforme a especificaciones acordadas.
                    <br>1.2. <strong>Perfeccionamiento:</strong> El contrato es vinculante al recibir EL PRESTADOR el comprobante de pago.
                    <br>1.3. <strong>Conformidad Estética:</strong> Al momento de la entrega física del producto, EL CLIENTE manifiesta total conformidad con las características estéticas. Opera la renuncia expresa a acción de rescisión por defectos estéticos visibles o variaciones artísticas. No aplica para vicios ocultos (Cláusula 6).

                    <br><br><strong>CLÁUSULA 2. RÉGIMEN ECONÓMICO Y CANCELACIONES:</strong>
                    <br>2.1. <strong>Precios y Anticipo:</strong> Expresados en MXN con IVA incluido. Se requerirá anticipo de entre 30% al 50%.
                    <br>2.2. <strong>No Retracto:</strong> Por ser bienes perecederos personalizados, no aplica derecho de retracto (Art. 93 Bis y 56 LFPC).
                    <br>2.3. <strong>Cancelaciones (Pena Convencional):</strong>
                    (a) Más de 120 horas: Reembolso 50% del anticipo. 
                    (b) Entre 48 y 120 horas: Reembolso 25% del anticipo. 
                    (c) Menos de 48 horas: El anticipo se pierde por completo.
                    <br>2.4. <strong>Abandono:</strong> Se garantiza la integridad por 12 horas. Después, se desechará sanitario sin reembolso.

                    <br><br><strong>CLÁUSULA 3. VARIACIONES ARTESANALES Y PROPIEDAD INTELECTUAL:</strong>
                    <br>3.1. <strong>Tolerancia Cromática:</strong> EL CLIENTE acepta variación de hasta 15% en tonalidades por reacción de pigmentos.
                    <br>3.2. <strong>Propiedad Intelectual:</strong> Diseños originales son de Momomy Bakery, pudiendo exhibirlos en portafolios. Para diseños de terceros (marcas), EL CLIENTE asume plena responsabilidad legal eximiendo a Momomy Bakery.

                    <br><br><strong>CLÁUSULA 4. SEGURIDAD ALIMENTARIA Y RESPONSABILIDAD:</strong>
                    <br>4.1. <strong>Conservación:</strong> El riesgo se traslada al CLIENTE en la entrega. Debe mantenerse entre 2°C y 6°C.
                    <br>4.2. <strong>Transporte Externo:</strong> Transporte a cargo del CLIENTE exime al PRESTADOR de daños mecánicos.
                    <br>4.3. <strong>Elementos No Comestibles:</strong> El producto contiene soportes (palillos, alambres). EL CLIENTE debe retirarlos antes del consumo.

                    <br><br><strong>CLÁUSULA 5. EXENCIÓN SANITARIA (ALÉRGENOS):</strong>
                    <br>5.1. <strong>Riesgo de Trazas:</strong> Las instalaciones <strong>NO son zona libre de trazas</strong>. Se manipula gluten, lácteos, huevo, soya, cacahuate y nueces de árbol. Existe riesgo de contaminación cruzada en todos los productos.
                    <br>5.2. <strong>Notificación:</strong> Es obligación del CLIENTE notificar cualquier alergia antes del pedido e informar a todos comensales, deslindando a EL PRESTADOR ante cualquier reacción alérgica.

                    <br><br><strong>CLÁUSULA 6. GARANTÍA Y RECLAMACIONES (VICIOS OCULTOS):</strong>
                    <br>6.1. <strong>Reclamación:</strong> Mermas internas de sabor deben reportarse en <strong>6 horas naturales</strong> tras entrega.
                    <br>6.2. <strong>Dictamen:</strong> Debe presentarse <strong>al menos el 80% del producto</strong> original con evidencia fotográfica.
                    <br>6.3. <strong>Límite Pecuniario:</strong> La responsabilidad <strong>nunca excederá el monto efectivamente pagado</strong>.

                    <br><br><strong>CLÁUSULA 7, 8 Y 9. PRIVACIDAD - COMPETENCIA - GENERALES:</strong>
                    <br>Datos protegidos por LFPDPPP. Controversias se someten a PROFECO y a los Tribunales de la ciudad de origen.

                    <br><br><span style="font-style: italic;">El pago del anticipo constituye la conformidad absolutoria a este contrato.</span>
                </td>
            </tr>
        </table>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px;">
        <table width="100%">
            <tr>
                 <td width="75%" style="vertical-align: middle;">
                    <div style="font-weight: bold; font-size: 10px; color: #f0427c;">EXPEDIENTE TÉCNICO Y SEGUIMIENTO</div>
                    <div style="font-size: 8px; color: #555; margin-top: 5px;">
                        Escanee el código QR a la derecha para ver el estatus en tiempo real de su pedido y consultar el historial completo.
                    </div>
                    <div style="font-size: 7px; color: #555; margin-top: 5px;">
                        Firma Digital de Orden: <strong>{{ order.id }}-{{ order.created_at|date("U") }}-MB</strong>
                    </div>
                    <div style="margin-top: 10px; border: 1px solid #ddd; padding: 5px; font-size: 6px; text-align: left; color: #777; width: 80%;">
                        CERTIFICACIÓN DE CALIDAD:<br>
                        Este documento valida que el producto salió de nuestras instalaciones cumpliendo todos los estándares de inocuidad.
                    </div>
                 </td>
                 <td width="25%" align="right" style="vertical-align: top;">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data={{ tracking_url|url_encode }}" style="width: 80px; height: 80px; border: 1px solid #ccc; padding: 2px;">
                 </td>
            </tr>
        </table>
    </div>

</body>
</html>
